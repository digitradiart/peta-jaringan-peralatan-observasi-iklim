<!-- Versi update index.html: menggunakan simbol HTML ringan, diwarnai sesuai provinsi -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Peta Jaringan Peralatan Observasi Iklim</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
      body {
        font-family: sans-serif;
      }
      #map {
        height: 80vh;
      }
      .controls {
        padding: 10px;
        background: #f9f9f9;
      }
      #summary table {
        border-collapse: collapse;
        margin-top: 10px;
        width: 100%;
      }
      #summary th,
      #summary td {
        border: 1px solid #aaa;
        padding: 5px;
        text-align: center;
      }
      #summary th {
        background-color: #eee;
      }
      #legend {
        /* position: absolute; */
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        font-size: 12px;
        max-height: 100px;
        width: 150px;
        overflow-y: auto;
        line-height: 1.4em;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <h1 id="judulPeta" style="text-align: center">
      Peta Jaringan Peralatan Observasi di Indonesia
    </h1>

    <div class="controls">
      <label>Filter Provinsi:</label>
      <select id="provinsiFilter" onchange="applyFilters()">
        <option value="">-- Semua Provinsi --</option>
      </select>

      <label style="margin-left: 20px">Filter Jenis Data:</label>
      <select id="jenisFilter" onchange="applyFilters()">
        <option value="">-- Semua Jenis --</option>
        <option value="PHOBS">PHOBS</option>
        <option value="ARG">ARG</option>
        <option value="AWS">AWS</option>
        <option value="AAWS">AAWS</option>
        <option value="ASRS">ASRS</option>
        <option value="IKLIMMIKRO">IKLIMMIKRO</option>
        <option value="SOIL">SOIL</option>
      </select>
    </div>

    <div id="map">
      <div id="legend"></div>
    </div>
    <!-- <div id="legend"></div> -->

    <div id="summary" class="controls"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([-2.5, 117], 3);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap",
      }).addTo(map);

      const geojsonTypes = [
        "PHOBS",
        "ARG",
        "AWS",
        "AAWS",
        "ASRS",
        "IKLIMMIKRO",
        "SOIL",
      ];
      const markers = [];
      const provinsiSet = new Set();
      const provinsiColors = {};
      let provinsiIndex = 0;

      const colorPalette = [
        "#e6194b",
        "#3cb44b",
        "#ffe119",
        "#4363d8",
        "#f58231",
        "#911eb4",
        "#46f0f0",
        "#f032e6",
        "#bcf60c",
        "#fabebe",
        "#008080",
        "#e6beff",
        "#9a6324",
        "#fffac8",
        "#800000",
        "#aaffc3",
        "#808000",
        "#ffd8b1",
        "#000075",
        "#808080",
        "#ffffff",
        "#000000",
        "#a83279",
        "#9c27b0",
        "#4caf50",
        "#03a9f4",
        "#e91e63",
        "#ff9800",
        "#cddc39",
        "#673ab7",
        "#2196f3",
        "#00bcd4",
        "#8bc34a",
        "#ffc107",
        "#ff5722",
        "#607d8b",
        "#795548",
        "#009688",
      ];

      function getNewColor(provinsi) {
        const color = colorPalette[provinsiIndex % colorPalette.length];
        provinsiColors[provinsi] = color;
        provinsiIndex++;
        return color;
      }

      const symbolMap = {
        PHOBS: "●",
        ARG: "▲",
        AWS: "■",
        AAWS: "□",
        ASRS: "▼",
        IKLIMMIKRO: "◆",
        SOIL: "▬",
      };

      geojsonTypes.forEach((type) => {
        fetch(`geojson/${type.toLowerCase()}.geojson`)
          .then((res) => res.json())
          .then((data) => {
            data.features.forEach((f) => {
              const coords = f.geometry.coordinates;
              const [lon, lat] = coords;
              const props = f.properties;
              const provinsi = props["PROVINSI"] || "TIDAK DIKETAHUI";

              if (!provinsiSet.has(provinsi)) {
                provinsiSet.add(provinsi);
                const opt = document.createElement("option");
                opt.value = provinsi;
                opt.text = provinsi;
                document.getElementById("provinsiFilter").appendChild(opt);
              }

              const color = provinsiColors[provinsi] || getNewColor(provinsi);
              const icon = L.divIcon({
                html: `<div style="color:${color}; font-size:14px; line-height:14px;">${
                  symbolMap[type] || "●"
                }</div>`,
                className: "",
                iconSize: [14, 14],
              });

              const marker = L.marker([lat, lon], { icon }).bindPopup(`
                <b>Provinsi:</b> ${provinsi}<br>
                <b>Kab/Kota:</b> ${props["KAB/KOTA"]}<br>
                <b>No Stasiun:</b> ${props["NO STASIUN"]}<br>
                <b>Jenis:</b> ${type}
              `);

              marker._provinsi = provinsi;
              marker._jenis = type;
              marker.addTo(map);
              markers.push(marker);
            });

            updateSummaryTable();
            updateLegend();
          });
      });

      function applyFilters() {
        const selectedProv = document.getElementById("provinsiFilter").value;
        const selectedJenis = document.getElementById("jenisFilter").value;

        markers.forEach((m) => {
          const matchProv = !selectedProv || m._provinsi === selectedProv;
          const matchJenis = !selectedJenis || m._jenis === selectedJenis;
          if (matchProv && matchJenis) m.addTo(map);
          else m.removeFrom(map);
        });
        updateSummaryTable();
        updateTitle();
      }

      function updateTitle() {
        const jenis = document.getElementById("jenisFilter").value;
        const prov = document.getElementById("provinsiFilter").value;
        let title = "Peta Jaringan Peralatan Observasi";
        if (jenis && prov) title += ` ${jenis} di ${prov}`;
        else if (jenis) title += ` ${jenis} di Indonesia`;
        else if (prov) title += ` di ${prov}`;
        else title += ` di Indonesia`;
        document.getElementById("judulPeta").innerText = title;
      }

      function updateSummaryTable() {
        const counts = {};
        markers.forEach((m) => {
          if (!map.hasLayer(m)) return;
          const prov = m._provinsi;
          const jenis = m._jenis;
          if (!counts[prov]) counts[prov] = {};
          if (!counts[prov][jenis]) counts[prov][jenis] = 0;
          counts[prov][jenis]++;
        });
        let html =
          "<h3>Ringkasan Data Terfilter</h3><table><tr><th>Provinsi</th>";
        geojsonTypes.forEach((j) => (html += `<th>${j}</th>`));
        html += "<th>Total</th></tr>";
        for (const prov in counts) {
          let total = 0;
          html += `<tr><td>${prov}</td>`;
          geojsonTypes.forEach((j) => {
            const val = counts[prov][j] || 0;
            html += `<td>${val}</td>`;
            total += val;
          });
          html += `<td>${total}</td></tr>`;
        }
        html += "</table>";
        document.getElementById("summary").innerHTML = html;
      }

      function updateLegend() {
        let html = "<b>Simbol per Jenis Data:</b><br>";
        for (const type in symbolMap) {
          html += `<div><span style='display:inline-block; width:16px; text-align:center;'>${symbolMap[type]}</span> ${type}</div>`;
        }
        html += "<br><b>Simbol Warna per Provinsi:</b><br>";
        for (const prov in provinsiColors) {
          html += `<div><span style='display:inline-block; width:12px; height:12px; background:${provinsiColors[prov]}; margin-right:4px;'></span> ${prov}</div>`;
        }
        document.getElementById("legend").innerHTML = html;
      }
    </script>
  </body>
</html>
