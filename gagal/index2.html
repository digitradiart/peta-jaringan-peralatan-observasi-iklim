<!DOCTYPE html>
<html>
  <head>
    <title>Peta Interaktif BMKG</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />
    <style>
      #map {
        height: 100vh;
      }
      .control-box {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        z-index: 9999;
        border: 1px solid gray;
        font-family: sans-serif;
        width: 240px;
      }
    </style>
  </head>
  <body>
    <div class="control-box">
      <h4>Filter & Search</h4>
      <button onclick="showAllLayers()">Show All</button>
      <button onclick="hideAllLayers()">Hide All</button><br /><br />
      <label>Provinsi:</label><br />
      <select id="provinsiFilter" onchange="filterByProvinsi(this.value)">
        <option value="">-- Semua --</option></select
      ><br /><br />
      <label>Cari:</label><br />
      <input
        type="text"
        id="searchBox"
        oninput="searchMarker()"
        placeholder="No Stasiun/Kab/Kota"
      />
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
      const map = L.map("map").setView([-2, 117], 5);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap",
      }).addTo(map);

      const colors = ["red", "blue", "green", "purple", "orange", "darkred"];
      const tabs = [
        "phobs",
        "arg",
        "aws",
        "aaws",
        "asrs",
        "iklimmikro",
        "soil",
      ];
      const layerGroups = {};
      const allMarkers = [];

      tabs.forEach((tab, i) => {
        const clusterGroup = L.markerClusterGroup();
        layerGroups[tab] = clusterGroup;

        fetch(`geojson/${tab}.geojson`)
          .then((res) => res.json())
          .then((data) => {
            data.features.forEach((f) => {
              const props = f.properties;
              const lat = f.geometry.coordinates[1];
              const lon = f.geometry.coordinates[0];
              const popup = `<b>${tab}</b><br>No Stasiun: ${props["NO STASIUN"]}<br>Kab/Kota: ${props["KAB/KOTA"]}<br>Provinsi: ${props["PROVINSI"]}`;
              const marker = L.circleMarker([lat, lon], {
                radius: 6,
                color: colors[i % colors.length],
                fillOpacity: 0.9,
              }).bindPopup(popup);

              marker._prov = props["PROVINSI"];
              marker._info = popup.toLowerCase();
              clusterGroup.addLayer(marker);
              allMarkers.push(marker);
              addProvinsiOption(props["PROVINSI"]);
            });

            map.addLayer(clusterGroup);
          });
      });

      // show/hide
      function showAllLayers() {
        Object.values(layerGroups).forEach((group) => map.addLayer(group));
      }
      function hideAllLayers() {
        Object.values(layerGroups).forEach((group) => map.removeLayer(group));
      }

      // filter by provinsi
      function filterByProvinsi(val) {
        allMarkers.forEach((m) => {
          const visible = val === "" || m._prov === val;
          m.setStyle({
            opacity: visible ? 1 : 0,
            fillOpacity: visible ? 0.9 : 0,
          });
          m[visible ? "addTo" : "removeFrom"](map); // tambahkan atau sembunyikan dari map
        });
      }

      // search
      function searchMarker() {
        const keyword = document
          .getElementById("searchBox")
          .value.toLowerCase();
        allMarkers.forEach((m) => {
          const visible = m._info.includes(keyword);
          m.setStyle({
            opacity: visible ? 1 : 0,
            fillOpacity: visible ? 0.9 : 0,
          });
          m[visible ? "addTo" : "removeFrom"](map);
        });
      }

      // isi dropdown provinsi unik
      const provSet = new Set();
      function addProvinsiOption(p) {
        if (!provSet.has(p)) {
          provSet.add(p);
          const opt = document.createElement("option");
          opt.value = p;
          opt.text = p;
          document.getElementById("provinsiFilter").appendChild(opt);
        }
      }
    </script>
  </body>
</html>
