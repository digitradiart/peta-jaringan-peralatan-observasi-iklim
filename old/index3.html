<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Peta Jaringan Peralatan Observasi Iklim</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
      body {
        font-family: sans-serif;
      }
      #map {
        height: 80vh;
      }
      .controls {
        padding: 10px;
        background: #f9f9f9;
      }
      #summary table {
        overflow-y: scroll;
        /* display: block; */
        border-collapse: collapse;
        margin-top: 10px;
        width: 100%;
      }
      #summary th,
      #summary td {
        border: 1px solid #aaa;
        padding: 5px;
        text-align: center;
      }
      #summary th {
        background-color: #eee;
      }

      #legend {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: white;
        padding: 10px;
        line-height: 1.4em;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      .legend-shape {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 4px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <!-- JUDUL PETA -->
    <h1 id="judulPeta" style="text-align: center">
      Peta Jaringan Peralatan Observasi di Indonesia
    </h1>

    <!-- TOMBOL FILTER DAN RINGKASAN DATA -->
    <div class="controls">
      <label>Filter Provinsi:</label>
      <select id="provinsiFilter" onchange="applyFilters()">
        <option value="">-- Semua Provinsi --</option>
      </select>

      <label style="margin-left: 20px">Filter Jenis Data:</label>
      <select id="jenisFilter" onchange="applyFilters()">
        <option value="">-- Semua Jenis --</option>
        <option value="PHOBS">PHOBS</option>
        <option value="ARG">ARG</option>
        <option value="AWS">AWS</option>
        <option value="AAWS">AAWS</option>
        <option value="ASRS">ASRS</option>
        <option value="IKLIMMIKRO">IKLIMMIKRO</option>
        <option value="SOIL">SOIL</option>
      </select>
    </div>

    <!-- PETA -->
    <div id="map">
      <div id="legend"></div>
    </div>

    <!-- LEGEND -->

    <!-- TABEL RINGKASAN DATA -->
    <div id="summary" class="controls"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
      // PLOT LAYER MAP INDONESIA
      const map = L.map("map").setView([-2.5, 117], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap",
      }).addTo(map);

      //   MENGAMBIL JENIS DATA GEOJSON
      const geojsonTypes = [
        "PHOBS",
        "ARG",
        "AWS",
        "AAWS",
        "ASRS",
        "IKLIMMIKRO",
        "SOIL",
      ];
      const markers = [];
      const provinsiSet = new Set();
      const provinsiColors = {};
      let provinsiIndex = 0;

      //   WARNA UNTUK 38 PROVINSI
      const colorPalette = [
        "#e6194b",
        "#3cb44b",
        "#ffe119",
        "#4363d8",
        "#f58231",
        "#911eb4",
        "#46f0f0",
        "#f032e6",
        "#bcf60c",
        "#fabebe",
        "#008080",
        "#e6beff",
        "#9a6324",
        "#fffac8",
        "#800000",
        "#aaffc3",
        "#808000",
        "#ffd8b1",
        "#000075",
        "#808080",
        "#ffffff",
        "#000000",
        "#a83279",
        "#9c27b0",
        "#4caf50",
        "#03a9f4",
        "#e91e63",
        "#ff9800",
        "#cddc39",
        "#673ab7",
        "#2196f3",
        "#00bcd4",
        "#8bc34a",
        "#ffc107",
        "#ff5722",
        "#607d8b",
        "#795548",
        "#009688",
      ];

      // FUNGSI UNTUK MENDAPATKAN PROVINSI
      function getNewColor(provinsi) {
        const color = colorPalette[provinsiIndex % colorPalette.length];
        provinsiColors[provinsi] = color;
        provinsiIndex++;
        return color;
      }

      //   FUNGSI UNTUK MENDAPATKAN BENTUK HTML BERDASARKAN JENIS DATA
      function getShapeHTML(type, color) {
        const shapes = {
          PHOBS: `width: 12px; height: 12px; background: ${color}; border-radius: 50%;`,
          ARG: `width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 12px solid ${color};`,
          AWS: `width: 12px; height: 12px; background: ${color};`,
          AAWS: `width: 12px; height: 12px; background: white; border: 2px solid ${color};`,
          ASRS: `width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 12px solid ${color};`,
          IKLIMMIKRO: `width: 12px; height: 12px; background: ${color}; transform: rotate(45deg);`,
          SOIL: `width: 12px; height: 6px; background: ${color};`,
        };
        const style = shapes[type] || shapes["PHOBS"];
        return `<div style="${style}"></div>`;
      }

      //   FUNGSI UNTUK MENGAMBIL DATA GEOJSON
      geojsonTypes.forEach((type) => {
        fetch(`geojson/${type.toLowerCase()}.geojson`)
          .then((res) => res.json())
          .then((data) => {
            data.features.forEach((f) => {
              const coords = f.geometry.coordinates;
              const lat = coords[1];
              const lon = coords[0];
              const props = f.properties;

              const provinsi = props["PROVINSI"] || "TIDAK DIKETAHUI";

              if (!provinsiSet.has(provinsi)) {
                provinsiSet.add(provinsi);
                const opt = document.createElement("option");
                opt.value = provinsi;
                opt.text = provinsi;
                document.getElementById("provinsiFilter").appendChild(opt);
              }

              const color = provinsiColors[provinsi] || getNewColor(provinsi);
              const icon = L.divIcon({
                html: getShapeHTML(type, color),
                className: "",
                iconSize: [12, 12],
              });

              const marker = L.marker([lat, lon], { icon }).bindPopup(`
              <b>Provinsi:</b> ${provinsi}<br>
              <b>Kab/Kota:</b> ${props["KAB/KOTA"]}<br>
              <b>No Stasiun:</b> ${props["NO STASIUN"]}<br>
              <b>Jenis:</b> ${type}
          `);

              marker._provinsi = provinsi;
              marker._jenis = type;
              marker.addTo(map);
              markers.push(marker);
            });

            updateSummaryTable();
            updateLegend();
          });
      });

      //   FUNGSI UNTUK MENERAPKAN FILTER
      function applyFilters() {
        const selectedProv = document.getElementById("provinsiFilter").value;
        const selectedJenis = document.getElementById("jenisFilter").value;

        markers.forEach((m) => {
          const matchProv = !selectedProv || m._provinsi === selectedProv;
          const matchJenis = !selectedJenis || m._jenis === selectedJenis;

          if (matchProv && matchJenis) {
            m.addTo(map);
          } else {
            m.removeFrom(map);
          }
        });
        updateSummaryTable();
        updateTitle();
      }

      // FUNGSI UNTUK MENGUPDATE JUDUL PETA
      function updateTitle() {
        const jenis = document.getElementById("jenisFilter").value;
        const prov = document.getElementById("provinsiFilter").value;
        let title = "Peta Jaringan Peralatan Observasi";

        if (jenis && prov) {
          title += ` ${jenis} di ${prov}`;
        } else if (jenis) {
          title += ` ${jenis} di Indonesia`;
        } else if (prov) {
          title += ` di ${prov}`;
        } else {
          title += ` di Indonesia`;
        }
        document.getElementById("judulPeta").innerText = title;
      }

      // FUNGSI UNTUK MENGUPDATE TABEL RINGKASAN DATA
      function updateSummaryTable() {
        const counts = {};
        markers.forEach((m) => {
          if (!map.hasLayer(m)) return;

          const prov = m._provinsi || "TIDAK DIKETAHUI";
          const jenis = m._jenis || "TIDAK DIKETAHUI";

          if (!counts[prov]) counts[prov] = {};
          if (!counts[prov][jenis]) counts[prov][jenis] = 0;
          counts[prov][jenis]++;
        });

        let html =
          "<h3>Ringkasan Data Terfilter</h3><table><tr><th>Provinsi</th>";
        geojsonTypes.forEach((j) => (html += `<th>${j}</th>`));
        html += "<th>Total</th></tr>";

        for (const prov in counts) {
          let total = 0;
          html += `<tr><td>${prov}</td>`;
          geojsonTypes.forEach((j) => {
            const val = counts[prov][j] || 0;
            html += `<td>${val}</td>`;
            total += val;
          });
          html += `<td>${total}</td></tr>`;
        }

        html += "</table>";
        document.getElementById("summary").innerHTML = html;
      }

      // FUNGSI UPDATE LEGEND
      function updateLegend() {
        let html = "<b>üóÇÔ∏è Legend:</b><br>";

        html += "<br><b>üìå Bentuk per Jenis Data:</b><br>";

        const shapeLegend = {
          PHOBS: {
            name: "Lingkaran",
            style: "border-radius:50%;background: #666;",
          },
          ARG: {
            name: "Segitiga",
            style:
              "width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 12px solid #666;",
          },
          AWS: {
            name: "Kotak",
            style: "width: 12px; height: 12px; background: #666;",
          },
          AAWS: {
            name: "Kotak Kosong",
            style:
              "width: 12px; height: 12px; background: white; border: 2px solid #666;",
          },
          ASRS: {
            name: "Segitiga Terbalik",
            style:
              "width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 12px solid #666;",
          },
          IKLIMMIKRO: {
            name: "Persegi Tumpul",
            style:
              "width: 12px; height: 12px; background: #666; transform: rotate(45deg);",
          },
          SOIL: {
            name: "Persegi Panjang",
            style: "width: 12px; height: 6px; background: #666;",
          },
        };

        for (const type in shapeLegend) {
          const s = shapeLegend[type];
          html += `<div><span class="legend-shape" style="${s.style}"></span> ${type} = ${s.name}</div>`;
        }

        html += "<br><b>üé® Warna per Provinsi:</b><br>";
        for (const prov in provinsiColors) {
          html += `<div><span class="legend-shape" style="background:${provinsiColors[prov]};"></span> ${prov}</div>`;
        }

        document.getElementById("legend").innerHTML = html;
      }
    </script>
  </body>
</html>
